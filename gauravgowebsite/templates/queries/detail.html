{% extends 'admin_base.html' %}
{% load static %}
{% block title %}Query Detail{% endblock %}

{% block main %}
<div class="card shadow m-2">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h5 class="mb-1">{{ query.name|default:"No name" }}</h5>
        <div class="small text-muted">{{ query.emailid }} &nbsp;|&nbsp; {{ query.contact|default:"—" }}</div>
        <div class="small text-muted">Received: {{ query.created_at|date:"d M Y, H:i" }}</div>
      </div>
      <div class="text-end">
        <a href="{% url 'queries:all' %}" class="btn btn-sm btn-outline-secondary">Back to list</a>
      </div>
    </div>

    <div class="mb-3">
      <h6>Message</h6>
      <p class="border rounded p-3" style="white-space:pre-wrap;">{{ query.message }}</p>
    </div>

    <div class="mb-3">
      <h6>Status</h6>
      {% if query.is_resolved %}
        <span class="badge bg-success">Resolved</span>
      {% else %}
        <span class="badge bg-warning text-dark">Unread</span>
      {% endif %}
    </div>

    <div class="row">
      <div class="col-md-6">
        <form action="{% url 'queries:toggle_resolved' query.id %}" method="post" class="mb-3">
          {% csrf_token %}
          <!-- Fixed: use Django template if/else for class -->
          <button type="submit" class="btn {% if query.is_resolved %}btn-secondary{% else %}btn-success{% endif %}">
            {% if query.is_resolved %}Mark Unresolved{% else %}Mark Resolved{% endif %}
          </button>

          <a href="#" class="btn btn-danger ms-2"
             onclick="event.preventDefault(); if(confirm('Delete this query?')) document.getElementById('delete-form').submit();">
            Delete
          </a>
        </form>

        <form id="delete-form" action="{% url 'queries:delete' query.id %}" method="post" style="display:none;">
          {% csrf_token %}
        </form>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">Contact Info</h6>
            <p class="mb-1"><strong>Email:</strong> {{ query.emailid|default:"—" }}</p>
            <p class="mb-1"><strong>Phone:</strong> {{ query.contact|default:"—" }}</p>
            <p class="mb-0"><strong>Company:</strong> {{ query.company|default:"—" }}</p>
          </div>
        </div>
      </div>
    </div>

    <hr>

    <div>
      <h6>Reply to Sender</h6>
      <form action="{% url 'queries:reply' query.id %}" method="post">
        {% csrf_token %}
        <div class="mb-2">
          <label for="subject" class="form-label">Subject</label>
          <input type="text" id="subject" name="subject" class="form-control" value="Re: Your query to {{ site_name|default:'Our Team' }}" required>
        </div>
        <div class="mb-2">
          <label for="body" class="form-label">Message</label>
          <textarea id="body" name="body" rows="6" class="form-control" required>Hi {{ query.name }},

Thank you for contacting us. </textarea>
        </div>
        <button class="btn btn-primary" type="submit">Send Reply</button>
        <button class="btn btn-outline-secondary ms-2" type="button" onclick="document.getElementById('body').value='';">Clear</button>
      </form>
    </div>

  </div>
</div>
{% endblock %}
